<!--
  Vorliyo: Freelance Platform - Owner Commission Tracking Page
  File: owner-commission-tracking.html (ROOT FILE)
  FIX: Ensured grid layouts are mobile-friendly (default to grid-cols-1)
-->
<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner - கமிஷன் கண்காணிப்பு</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        #adminMain { min-height: 80vh; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Navbar (Owner) -->
    <header class="bg-red-700 shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <a href="owner-admin.html" class="text-3xl font-extrabold text-white tracking-tight">Vorliyo Admin</a>
            <a href="owner-admin.html" class="text-white hover:text-red-200 flex items-center p-2 rounded-lg border border-red-300">
                <span data-lucide="layout-dashboard" class="w-5 h-5 mr-1"></span> டாஷ்போர்டு
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main id="adminMain" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-8 flex items-center">
             <span data-lucide="wallet" class="w-8 h-8 mr-2 text-green-700"></span> Manual கமிஷன் கண்காணிப்பு
        </h1>
        
        <p class="text-red-600 font-semibold mb-4">
            **பாதுகாப்பு குறிப்பு:** இந்த பக்கம் Owner Admin Panel (owner-admin.html) வழியாக மட்டுமே அணுகப்பட வேண்டும்.
        </p>
        
        <!-- FIX: Ensured grid starts with grid-cols-1 for mobile, then lg:grid-cols-3 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Column: Commission Summary -->
            <div class="lg:col-span-1 space-y-4">
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-700">
                    <h2 class="text-xl font-bold text-gray-900 mb-3">மொத்த வருவாய் (Total Commission)</h2>
                    <p class="text-3xl font-extrabold text-green-700" id="totalCommission">LKR 0.00</p>
                    <p class="text-sm text-gray-500 mt-1">கமிஷன் விகிதம்: 10% (உதாரணம்)</p>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-900 mb-3">Manual Transaction பதிவு</h2>
                    <form id="addTransactionForm" class="space-y-4">
                        <div>
                            <label for="jobID" class="block text-sm font-medium text-gray-700">வேலை ID (Job ID)</label>
                            <input id="jobID" type="text" placeholder="சமர்ப்பிக்கப்பட்ட வேலை ID" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label for="totalAmount" class="block text-sm font-medium text-gray-700">மொத்த வேலை மதிப்பு (LKR)</label>
                            <input id="totalAmount" type="number" placeholder="எ.கா: 10000" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                        <button type="submit" class="w-full bg-red-600 text-white p-2 rounded-lg hover:bg-red-700 transition duration-150">
                            Transaction-ஐச் சேர்
                        </button>
                        <p id="transactionMessage" class="text-sm font-medium text-center h-4 mt-1"></p>
                    </form>
                </div>
            </div>

            <!-- Right Column: Transaction List -->
            <div class="lg:col-span-2 space-y-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">பதிவு செய்யப்பட்ட பரிவர்த்தனைகள் (Transactions)</h2>
                 <div id="transactionList" class="space-y-3">
                     <p class="text-center text-gray-500">பரிவர்த்தனைகள் ஏற்றப்படுகிறது...</p>
                 </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 text-center">
            <p>&copy; 2024 Vorliyo Admin. sahan.</p>
        </div>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config (Please make sure this is your config!)
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDD755-oGyx0hwrLykhF7m2k1uWFnLFMDQ",
            authDomain: "vorliyo.firebaseapp.com",
            projectId: "vorliyo",
            storageBucket: "vorliyo.firebasestorage.app",
            messagingSenderId: "480604417883",
            appId: "1:480604417883:web:5b4926a2a1b21f3ae2747e",
        };
        
        const firebaseConfig = FIREBASE_CONFIG;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'vorliyo-default-app-id';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const ADMIN_EMAIL = 'vorliyopro@gmail.com';
        const COMMISSION_RATE = 0.10; // 10% Commission Rate
        
        const TRANSACTIONS_COLLECTION = collection(db, 'artifacts', appId, 'owner', 'data', 'manual_transactions');

        // --- AUTH CHECK (Owner Only) ---
        onAuthStateChanged(auth, (user) => {
            if (!user || user.email !== ADMIN_EMAIL) {
                // Not the admin, redirect to admin login
                if (window.location.href.includes('owner-commission-tracking.html')) {
                    // Simple redirection logic - needs improvement in a real app
                    alert("Unauthorized access. Redirecting to Admin Login.");
                    window.location.href = 'owner-admin.html';
                }
            } else {
                 listenToTransactions();
            }
        });

        // --- TRANSACTION LISTENER ---
        function listenToTransactions() {
            const list = document.getElementById('transactionList');
            onSnapshot(query(TRANSACTIONS_COLLECTION), (snapshot) => {
                const transactions = [];
                let totalCommission = 0;
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const commission = data.totalAmount * COMMISSION_RATE;
                    totalCommission += commission;
                    transactions.push({ id: doc.id, ...data, commission });
                });
                
                renderTransactions(transactions, list);
                document.getElementById('totalCommission').textContent = `LKR ${totalCommission.toFixed(2).toLocaleString()}`;
                
            }, (error) => { console.error("Error fetching transactions:", error); });
        }
        
        function renderTransactions(transactions, list) {
            if (transactions.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500">இதுவரை பரிவர்த்தனைகள் எதுவும் பதிவு செய்யப்படவில்லை.</p>';
                return;
            }
            list.innerHTML = transactions.map(t => `
                <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-green-500">
                    <h4 class="text-lg font-bold text-gray-900">வேலை ID: ${t.jobID}</h4>
                    <p class="text-sm text-gray-600 mb-1">**மொத்த மதிப்பு:** LKR ${t.totalAmount.toLocaleString()}</p>
                    <p class="text-base font-semibold text-green-700">**கமிஷன் (10%):** LKR ${t.commission.toFixed(2).toLocaleString()}</p>
                    <p class="text-xs text-gray-500">பதிவு செய்தது: ${new Date(t.createdAt.toDate()).toLocaleDateString()}</p>
                </div>
            `).join('');
        }

        // --- TRANSACTION SUBMISSION ---
        document.getElementById('addTransactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const jobID = document.getElementById('jobID').value;
            const totalAmount = parseFloat(document.getElementById('totalAmount').value);
            const msgBox = document.getElementById('transactionMessage');
            
            if (isNaN(totalAmount) || totalAmount <= 0) {
                msgBox.textContent = 'சரியான தொகையை உள்ளிடவும்.';
                msgBox.classList.add('text-red-600');
                return;
            }
            
            msgBox.textContent = 'பதிவு செய்கிறது...';
            msgBox.classList.remove('text-red-600', 'text-green-600');

            const newTransaction = {
                jobID: jobID,
                totalAmount: totalAmount,
                commissionRate: COMMISSION_RATE,
                createdAt: new Date(),
            };

            try {
                await addDoc(TRANSACTIONS_COLLECTION, newTransaction);
                
                msgBox.textContent = 'பரிவர்த்தனை வெற்றிகரமாகப் பதிவு செய்யப்பட்டது!';
                msgBox.classList.add('text-green-600');
                document.getElementById('addTransactionForm').reset();

            } catch (error) {
                console.error("Error adding transaction:", error);
                msgBox.textContent = 'பதிவு செய்வதில் பிழை ஏற்பட்டது.';
                msgBox.classList.add('text-red-600');
            }
        });
        
        lucide.createIcons(); 
        
    </script>
</body>
</html>
