<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vorliyo - டாஷ்போர்டு</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <a href="user-index.html" class="text-3xl font-extrabold text-indigo-600 tracking-tight">Vorliyo</a>
            <button onclick="handleSignOut()" class="text-red-500 hover:text-red-700 flex items-center">
                <span data-lucide="log-out" class="w-5 h-5 mr-1"></span> வெளியேற
            </button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6 flex items-center">
            <span id="userGreeting">பயனர் டாஷ்போர்டு</span>, <span id="userTypeBadge" class="ml-3 text-sm font-semibold text-white px-3 py-1 rounded-full bg-gray-500">ஏற்றுகிறது...</span>
        </h1>
        
        <div id="loadingIndicator" class="text-center text-lg text-indigo-500 font-semibold">
            உள்நுழைவு நிலையைச் சரிபார்க்கிறது...
        </div>

        <div id="dashboardContent" class="hidden grid grid-cols-1 lg:grid-cols-4 gap-8">
            
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-indigo-600">
                    <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center"><span data-lucide="user-circle" class="w-6 h-6 mr-2"></span> உங்கள் சுயவிவரம்</h2>
                    <p class="text-gray-700 mb-2">**பெயர்:** <span id="userName"></span></p>
                    <p class="text-gray-700 mb-4">**மின்னஞ்சல்:** <span id="userEmail"></span></p>
                    <button onclick="changeDashboardTab('profile')" class="w-full bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 transition duration-150 flex items-center justify-center">சுயவிவர அமைப்புகள்</button>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-lg space-y-2 overflow-x-auto whitespace-nowrap lg:overflow-visible lg:whitespace-normal">
                    <button onclick="changeDashboardTab('clientJobs')" id="navClientJobs" class="w-full text-left p-3 rounded-lg text-gray-700 hover:bg-gray-100 font-semibold flex items-center active-tab" data-type="client">
                        <span data-lucide="briefcase" class="w-5 h-5 mr-2"></span> எனது வேலைப் பட்டியல்கள்
                    </button>
                    <button onclick="changeDashboardTab('freelancerGigs')" id="navFreelancerGigs" class="w-full text-left p-3 rounded-lg text-gray-700 hover:bg-gray-100 font-semibold flex items-center" data-type="freelancer">
                        <span data-lucide="hard-hat" class="w-5 h-5 mr-2"></span> எனது சேவைகள் (Gigs)
                    </button>
                    <button onclick="changeDashboardTab('jobProposals')" id="navJobProposals" class="w-full text-left p-3 rounded-lg text-gray-700 hover:bg-gray-100 font-semibold flex items-center" data-type="freelancer">
                        <span data-lucide="send" class="w-5 h-5 mr-2"></span> நான் விண்ணப்பித்த வேலைகள்
                    </button>
                </div>
            </div>

            <div class="lg:col-span-3 space-y-6">
                
                <div id="profileTab" class="dashboard-tab bg-white p-6 rounded-xl shadow-lg hidden">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2">சுயவிவர அமைப்புகள்</h2>
                     <form id="profileUpdateForm" class="space-y-4">
                        <div>
                            <label for="profileTagline" class="block text-sm font-medium text-gray-700">ஒரு வரிக்கோஷம் (Tagline - Freelancers only)</label>
                            <input id="profileTagline" type="text" placeholder="நான் ஒரு உலகத் தரம் வாய்ந்த வடிவமைப்பாளர்." class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label for="profileAbout" class="block text-sm font-medium text-gray-700">உங்களைப் பற்றி</label>
                            <textarea id="profileAbout" rows="4" placeholder="உங்கள் திறமைகள் மற்றும் அனுபவங்களைப் பற்றி விரிவாக எழுதவும்." class="mt-1 block w-full p-2 border border-gray-300 rounded-lg"></textarea>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition duration-150">சுயவிவரத்தை சேமிக்க</button>
                        <p id="profileMessage" class="text-sm text-center font-medium h-4"></p>
                    </form>
                </div>

                <div id="clientJobsTab" class="dashboard-tab bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2 flex justify-between items-center">
                        நான் வெளியிட்ட வேலைகள் 
                        <a href="user-post-job.html" class="text-sm bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 flex items-center">
                            <span data-lucide="plus" class="w-4 h-4 mr-1"></span> புதிய வேலை
                        </a>
                    </h2>
                    <div id="clientJobsList" class="space-y-3">
                        <p class="text-gray-500">வேலைப் பட்டியல்கள் ஏற்றுகிறது...</p>
                    </div>
                </div>

                <div id="freelancerGigsTab" class="dashboard-tab bg-white p-6 rounded-xl shadow-lg hidden">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2 flex justify-between items-center">
                        நான் வெளியிட்ட சேவைகள் (Gigs)
                        <a href="user-post-service.html" class="text-sm bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 flex items-center">
                            <span data-lucide="plus" class="w-4 h-4 mr-1"></span> புதிய சேவை
                        </a>
                    </h2>
                     <div id="freelancerGigsList" class="space-y-3">
                        <p class="text-gray-500">சேவைகள் ஏற்றுகிறது...</p>
                    </div>
                </div>

                 <div id="jobProposalsTab" class="dashboard-tab bg-white p-6 rounded-xl shadow-lg hidden">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2">நான் விண்ணப்பித்த வேலைகள்</h2>
                     <div id="jobProposalsList" class="space-y-3">
                        <p class="text-gray-500">விண்ணப்பங்கள் ஏற்றுகிறது...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        // Importing modules using the specific version URL
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut, 
            updateProfile 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            collection, 
            query, 
            where, 
            onSnapshot, 
            updateDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ********** உங்கள் Firebase Config-ஐ இங்கே மாற்றவும்! **********
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDD755-oGyx0hwrLykhF7m2k1uWFnLFMDQ",
            authDomain: "vorliyo.firebaseapp.com",
            projectId: "vorliyo",
            storageBucket: "vorliyo.firebasestorage.app",
            messagingSenderId: "480604417883",
            appId: "1:480604417883:web:5b4926a2a1b21f3ae2747e",
        };
        
        const firebaseConfig = FIREBASE_CONFIG;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'vorliyo-default-app-id';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let userProfile = null;
        
        const getProfileDocRef = (uid) => doc(db, 'artifacts', appId, 'users', uid, 'profile', uid);
        const PUBLIC_JOBS_COLLECTION = collection(db, 'artifacts', appId, 'public', 'data', 'jobs');
        const PUBLIC_SERVICES_COLLECTION = collection(db, 'artifacts', appId, 'public', 'data', 'services');
        const PROPOSALS_COLLECTION = collection(db, 'artifacts', appId, 'public', 'data', 'proposals');


        // --- AUTH STATE MANAGEMENT ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loadingIndicator').classList.add('hidden');
                document.getElementById('dashboardContent').classList.remove('hidden');
                fetchUserProfile(user.uid);
            } else {
                // Not logged in: Redirect to login page
                document.getElementById('loadingIndicator').textContent = 'உள்நுழையவில்லை. உள்நுழையவும்...';
                setTimeout(() => { window.location.href = './user-login.html'; }, 1500);
            }
        });

        window.handleSignOut = () => {
            signOut(auth).then(() => {
                window.location.href = './user-index.html'; 
            }).catch((error) => {
                console.error("Sign Out Error:", error);
            });
        }
        
        // --- PROFILE MANAGEMENT & DATA FETCHING ---
        async function fetchUserProfile(uid) {
            const docRef = getProfileDocRef(uid);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                userProfile = docSnap.data();
                // Ensure isFreelancer flag is set correctly based on userType
                if (userProfile.isFreelancer === undefined) {
                    userProfile.isFreelancer = userProfile.userType === 'freelancer';
                }

                renderProfile();
                setupDashboard(userProfile.userType);
                // Start listening to specific data based on user type
                listenToClientJobs(uid, userProfile.userType);
                listenToFreelancerData(uid, userProfile.userType);
            } else {
                // This is the error point - Profile document not found!
                console.error("User profile document not found. Redirecting to complete registration.");
                alert("உங்கள் சுயவிவரம் முழுமையாக இல்லை. மீண்டும் உள்நுழையவும்."); 
                signOut(auth);
            }
        }
        
        function renderProfile() {
            if (!userProfile) return;
            
            document.getElementById('userName').textContent = userProfile.name || currentUser.displayName;
            document.getElementById('userEmail').textContent = userProfile.email;
            document.getElementById('profileTagline').value = userProfile.tagline || '';
            document.getElementById('profileAbout').value = userProfile.about || '';
            document.getElementById('userGreeting').textContent = `${userProfile.name}, வணக்கம்!`;

            const badge = document.getElementById('userTypeBadge');
            badge.textContent = userProfile.userType === 'freelancer' ? 'ஃப்ரீலான்சர்' : 'வாடிக்கையாளர்';
            badge.classList.remove('bg-gray-500', 'bg-red-600', 'bg-blue-600', 'bg-green-600');
            badge.classList.add(userProfile.userType === 'freelancer' ? 'bg-green-600' : 'bg-blue-600');
            lucide.createIcons();
        }
        
        // --- DASHBOARD SETUP & TABS ---
        function setupDashboard(userType) {
            document.querySelectorAll('[data-type]').forEach(navItem => {
                // Hide freelancer specific tabs if user is only a client
                if (userType === 'client' && navItem.getAttribute('data-type') === 'freelancer') {
                    navItem.classList.add('hidden');
                }
            });
            
            // Set initial tab based on user type
            if (userType === 'freelancer') {
                changeDashboardTab('freelancerGigs');
            } else {
                changeDashboardTab('clientJobs');
            }
        }
        
        window.changeDashboardTab = (tabName) => {
            // Hide all tabs
            document.querySelectorAll('.dashboard-tab').forEach(tab => tab.classList.add('hidden'));
            // Remove active style from all nav buttons
            document.querySelectorAll('.p-3.rounded-lg').forEach(nav => nav.classList.remove('bg-indigo-100'));

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            // Set active style on selected nav button
            const navButton = document.getElementById('nav' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            if(navButton) navButton.classList.add('bg-indigo-100');
            
            // Special handling for Profile tab
            if (tabName === 'profile') {
                document.getElementById('profileTab').classList.remove('hidden');
            }
            lucide.createIcons();
        }
        
        // --- PROFILE UPDATE SUBMISSION ---
        document.getElementById('profileUpdateForm').addEventListener('submit', async (e) => {
             e.preventDefault();
             const tagline = document.getElementById('profileTagline').value;
             const about = document.getElementById('profileAbout').value;
             const msgBox = document.getElementById('profileMessage');
             
             if (!currentUser) return;
             
             msgBox.textContent = 'சேமிக்கிறது...';

             try {
                const profileRef = getProfileDocRef(currentUser.uid);
                await updateDoc(profileRef, { tagline, about });
                
                userProfile.tagline = tagline;
                userProfile.about = about;
                msgBox.textContent = 'சுயவிவரம் வெற்றிகரமாக சேமிக்கப்பட்டது!';
                msgBox.classList.remove('text-red-600');
                msgBox.classList.add('text-green-600');
             } catch (error) {
                console.error("Error updating profile:", error);
                msgBox.textContent = 'சுயவிவரத்தை சேமிப்பதில் பிழை ஏற்பட்டது.';
                msgBox.classList.remove('text-green-600');
                msgBox.classList.add('text-red-600');
             }
        });
        
        // --- DATA LISTENERS ---
        
        // 1. Client Jobs Listener (Jobs posted by current user)
        function listenToClientJobs(uid, userType) {
            const list = document.getElementById('clientJobsList');
            const q = query(PUBLIC_JOBS_COLLECTION, where("clientId", "==", uid));
            
            onSnapshot(q, (snapshot) => {
                const jobs = [];
                snapshot.forEach((doc) => {
                    jobs.push({ id: doc.id, ...doc.data() });
                });
                renderClientJobs(jobs, list);
            }, (error) => { console.error("Error fetching client jobs:", error); });
        }
        
        function renderClientJobs(jobs, list) {
            if (jobs.length === 0) {
                list.innerHTML = `<p class="text-gray-500">நீங்கள் இன்னும் எந்த வேலையையும் வெளியிடவில்லை. <a href="user-post-job.html" class="text-indigo-600 underline">புதிய வேலையை வெளியிட</a>.</p>`;
                return;
            }
            
            list.innerHTML = jobs.map(job => `
                <div class="p-3 border border-gray-200 rounded-lg flex justify-between items-center bg-white shadow-sm">
                    <div>
                        <p class="font-semibold text-gray-800">${job.title}</p>
                        <p class="text-sm text-green-600">LKR ${job.budget} | ${job.status}</p>
                    </div>
                    <a href="client-job-tracking.html?id=${job.id}" class="text-indigo-500 hover:text-indigo-700 p-2 rounded-full transition duration-150">
                        <span data-lucide="eye" class="w-5 h-5"></span> கண்காணிக்க
                    </a>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // 2. Freelancer Data Listeners (Gigs and Proposals)
        function listenToFreelancerData(uid, userType) {
            if (userType !== 'freelancer') return;
            
            // 2a. Freelancer Gigs Listener
            const gigsList = document.getElementById('freelancerGigsList');
            const gigsQuery = query(PUBLIC_SERVICES_COLLECTION, where("freelancerId", "==", uid));
            
            onSnapshot(gigsQuery, (snapshot) => {
                const gigs = [];
                snapshot.forEach((doc) => {
                    gigs.push({ id: doc.id, ...doc.data() });
                });
                renderFreelancerGigs(gigs, gigsList);
            }, (error) => { console.error("Error fetching freelancer gigs:", error); });
            
            // 2b. Job Proposals Listener
            const proposalsList = document.getElementById('jobProposalsList');
            const proposalsQuery = query(PROPOSALS_COLLECTION, where("freelancerId", "==", uid));
            
             onSnapshot(proposalsQuery, (snapshot) => {
                const proposals = [];
                snapshot.forEach((doc) => {
                    proposals.push({ id: doc.id, ...doc.data() });
                });
                renderFreelancerProposals(proposals, proposalsList);
            }, (error) => { console.error("Error fetching freelancer proposals:", error); });
        }
        
        function renderFreelancerProposals(proposals, list) {
             if (proposals.length === 0) {
                list.innerHTML = `<p class="text-gray-500">நீங்கள் இன்னும் எந்த வேலைக்கும் விண்ணப்பிக்கவில்லை.</p>`;
                return;
            }
            
            list.innerHTML = proposals.map(p => `
                 <div class="p-3 border border-gray-200 rounded-lg flex justify-between items-center bg-white shadow-sm">
                    <div>
                        <p class="font-semibold text-gray-800">Job ID: ${p.jobId.substring(0, 8)}...</p>
                        <p class="text-sm text-green-600">விலை: LKR ${p.proposalPrice} | நிலை: ${p.status}</p>
                    </div>
                    <a href="freelancer-job-view.html?id=${p.jobId}" class="text-indigo-500 hover:text-indigo-700 p-2 rounded-full transition duration-150">
                        <span data-lucide="eye" class="w-5 h-5"></span> விவரங்கள்
                    </a>
                </div>
            `).join('');
            lucide.createIcons();
        }

    </script>
</body>
</html>
```eof
